var __extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a])};return function(e,a){function i(){this.constructor=e}t(e,a),e.prototype=null===a?Object.create(a):(i.prototype=a.prototype,new i)}}();define(["require","exports","../DZPKCardLogic","../DZPKCardType","../Holdem","./DZPKSceneView","../../../mbase/base/MViewModel"],function(t,e,a,i,s,o,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=function(t){function e(){var e=t.call(this)||this;return e._player_list=[],e._my_seat_no=-1,e._public_cards=[],e.setAtlasName="res/atlas/dzpk/gameScene.atlas,res/atlas/dzpk/zh-cn/font/buttonFont.atlas,res/atlas/dzpk/zh-cn/font/operateActionFont.atlas,res/atlas/dzpk/zh-cn/font/gameOverFont.atlas,res/atlas/dzpk/zh-cn/font/cardTypeFont.atlas,res/atlas/dzpk/cards.atlas",e.setClass=o.DZPKSceneView,e.setViewPath="game_dzpk/DZPKScene,game_dzpk/DZPKHead,game_dzpk/DZPKCards",e}return __extends(e,t),e.prototype.onEarlyWin=function(){this.view.updataOperatePanel(0);var t=this.getPlayerBySeat(this.deckData.seat);t.getScoreCount=this.deckData.pot-t.bet,0==t.bet?t.getScoreCount=0:t.getScoreCount>0&&(t.chip=t.chip+t.bet+Math.ceil(t.getScoreCount*(1-this.agentData.deductRate))),t.userRank=0,t.cardType=0,this.view.updateTablePool(this.deckData.pot),this.view.onEarlyEnd(this._player_list)},e.prototype.onShowdown=function(){this.view.updataOperatePanel(0);var t,e,a,i,s=0,o=this.deckData.holeCards.length,r=[];for(s=0;s<o;s++)if(e=this.deckData.holeCards[s],t=CFun.getItem(this._player_list,"seatNO",e.seatNO)){t.hole1=e.cards[0],t.hole2=e.cards[1];var n=this.getCardTypeByIndex(t);a=CFun.getItem(this.deckData.winner,"seatNO",t.seatNO),i=CFun.getItem(this.deckData.bestHands,"seatNO",t.seatNO),a?(t.getScoreCount=t.bet>a.chip?-(t.bet-a.chip):a.chip-t.bet,t.userRank=a.order,t.cardType=i.type,t.getScoreCount>0?t.chip=t.chip+t.bet+Math.ceil(t.getScoreCount*(1-this.agentData.deductRate)):t.chip=t.chip+t.bet+t.getScoreCount,r.push(n)):(t.getScoreCount=-t.bet,t.cardType=i.type),this.view.showCardTypeTip(n.seatNO,n.cardType,n.cardsIndexs,n.centerCardIndexs)}else t.isFold&&(t.getScoreCount=0==t.bet?0:-t.bet);this.view.onShowdown(this._player_list,r),this.view.updateTablePool(this.deckData.pot)},e.prototype.getCardTypeByIndex=function(t){if(!this._player_list||this._player_list.length<=0)return null;var e,s,o=this._public_cards,r=[];if(0!=t.hole1&&(r.push(t.hole1),r.push(t.hole2)),(e=a.DZPKCardLogic.ins.getCardTypeCards(r,o)).cardType==i.DZPKCardType.ERROR)return null;var n,h=e.cards,l=[],c=[];for(s=0;s<h.length;s++)if((n=h[s])>0){var p=r.indexOf(n);-1!=p&&l.push(p),-1!=(p=o.indexOf(n))&&c.push(p)}return{seatNO:t.seatNO,cardType:e.cardType,cardsIndexs:l,centerCardIndexs:c}},e.prototype.onShowCard=function(){var t,e,a=0,i=this.deckData.holeCards.length;for(a=0;a<i;a++)e=this.deckData.holeCards[a],(t=CFun.getItem(this._player_list,"seatNO",e.seatNO))&&(t.hole1=e.cards[0],t.hole2=e.cards[1]);this.view.onShowCard(this._player_list),this.view.updataOperatePanel(-1),this.updateCardsType()},e.prototype.onViewCard=function(){},e.prototype.onOpenFlop=function(){this._public_cards=this._public_cards.concat(this.deckData.cards),this.view.updatePublicCards(this._public_cards,0,2),this.view.updateTablePool(this.deckData.pot),this.updateCardsType()},e.prototype.onOpenTurn=function(){this._public_cards=this._public_cards.concat(this.deckData.card),this.view.updatePublicCards(this._public_cards,3,3),this.view.updateTablePool(this.deckData.pot),this.updateCardsType()},e.prototype.onOpenRive=function(){this._public_cards=this._public_cards.concat(this.deckData.card),this.view.updatePublicCards(this._public_cards,4,4),this.view.updateTablePool(this.deckData.pot),this.updateCardsType()},e.prototype.updateCardsType=function(){var t,e=this._player_list,a=(this._public_cards,0),i=e.length;for(a=0;a<i;a++)(t=this.getCardTypeByIndex(e[a]))&&this.view.showCardTypeTip(t.seatNO,t.cardType,t.cardsIndexs,t.centerCardIndexs)},e.prototype.recvHoleCard=function(t,e){var a=this.getMeInfo();a.hole1=e?t:this.agentData.cards[0],a.hole2=e||this.agentData.cards[1],this.view.sendCards(this._player_list),this.view.onShowBank(this.deckData.dealer),this.view.updateTablePool(0),this.updateCardsType()},e.prototype.seatWait=function(){var t=this.deckData.seat,e=this.getPlayerBySeat(t);if(e){e.action=this.deckData.action,e.cd=this.deckData.cd,e.myturn=!0,this.view.showWait(e);var a=this.getMeInfo();a||CFun.throw("seatWait中无法获取自己的信息");var i=-1;e.rid==a.rid?i=1:0!=a.chip&&(i=2),t!=this._my_seat_no&&a.action==s.TEXAS_HOLDEM_ACTION.FOLD&&(i=0);var o={bet:this.agentData.bet,miniBet:this.deckData.miniBet,chip:a.chip,stageBet:a.stageBet,pot:this.deckData.pot,miniRaise:this.deckData.miniRaise};this.view.updataOperatePanel(i,o),this.view.updateTablePool(this.deckData.pot)}},e.prototype.seatPlay=function(){var t=this.deckData.seat,e=this.getPlayerBySeat(t);e&&(e.action=this.deckData.action,e.bet=e.bet+this.deckData.bet,e.chip=e.chip-this.deckData.bet,e.stageBet=e.stageBet+this.deckData.bet,e.amount=this.deckData.bet,e.myturn=!1,e.isFold=this.deckData.action==s.TEXAS_HOLDEM_ACTION.FOLD,e.rid==this.playerData.rid&&0==e.chip&&this.view.updataOperatePanel(-1),this.view.showPlay(e))},e.prototype.startNextHand=function(){this.view.showGameNo(this.agentData.gameNo)},e.prototype.anyTakeIn=function(){var t=this.deckData.seat,e=this.deckData.amount,a=this.getPlayerBySeat(t);a.chip+=e,this.view.showPlayerChip(a.chip,t)},e.prototype.playerTakeIn=function(){var t=this.playerData.amount,e=this.getPlayerBySeat(this._my_seat_no);e.chip=t,this.view.showPlayerChip(e.chip,this._my_seat_no)},e.prototype.getPlayerBySeat=function(t){var e=0,a=this._player_list.length;for(e=0;e<a;e++)if(this._player_list[e].seatNO==t)return this._player_list[e];return null},e.prototype.showPlayers=function(){this.view.showPlayers(this._player_list,this._my_seat_no)},e.prototype.showPlayer=function(t){this.view.showPlayer(t)},e.prototype.getMeInfo=function(){var t,e=0,a=this._player_list.length;for(e=0;e<a;e++)if((t=this._player_list[e]).rid==this.playerData.rid)return t;return null},e.prototype.playerEnter=function(){var t=this.deckData,e={rid:t.rid,name:t.name,icon:t.icon,sex:t.sex,seatNO:t.seat,take:0,chip:t.chip,bet:0,action:0,amount:0,busted:!0,ranking:0,isFold:!1,myturn:!1,defaultAction:0,cd:0,stageBet:0,hole1:0,hole2:0};this.addPlayerTo_player_list(e),e.rid==this.playerData.rid?(this._my_seat_no=e.seatNO,this.showPlayers(),this.sendTakein()):this.showPlayer(e)},e.prototype.playersEnter=function(){var t=this.agentData.myHoleCards,e=this.agentData.pokers;this._public_cards=this.agentData.publicCards;var a,i,o,r=0,n=e.length;for(r=0;r<n;r++)i={rid:(a=e[r]).rid,name:a.name,icon:a.icon,sex:a.sex,seatNO:a.seatNO,take:a.take,chip:a.chip,bet:a.bet,action:a.action,amount:a.amount,busted:a.busted,ranking:a.ranking,isFold:a.fold,myturn:a.myturn,defaultAction:a.defaultAction,cd:a.cd,stageBet:a.stageBet,viewCardOne:a.viewCardOne,viewCardTwo:a.viewCardTwo,hole1:0,hole2:0},this.addPlayerTo_player_list(i),a.rid==this.playerData.rid&&(t.length>0&&(i.hole1=t[0],i.hole2=t[1]),this._my_seat_no=i.seatNO,o=i);if(this._my_seat_no>=0){if(this.showPlayers(),this.view.updatePublicCards(this._public_cards,0,this._public_cards.length-1),this.view.updateTablePool(this.deckData.pot),!o.myturn){var h={bet:this.agentData.bet,miniBet:this.deckData.miniBet,chip:o.chip,stageBet:o.stageBet,pot:this.deckData.pot,miniRaise:this.deckData.miniRaise};this.view.updataOperatePanel(1,h),this.view.showWait(o)}o.action==s.TEXAS_HOLDEM_ACTION.FOLD&&this.view.showPlay(o),this.recvHoleCard(o.hole1,o.hole2),0!=this.playerData.curDeck&&0==this.agentData.take&&this.sendTakein()}},e.prototype.onEnterDeck=function(){this.playersEnter(),this.view.showGameInfo(this.deckData.blink,this.deckData.ante)},e.prototype.sendTakein=function(){var t=CFun.getLSItem(StorageKeys.DZPKTakeScore+this.playerData.lastRoomId,"Object");if("{}"!=JSON.stringify(t)){var e=this.playerData.gold>=t.takeScore?t.takeScore:this.playerData.gold;if(t.isautoTakeScore)this.sendData(16778283,[this.playerData.roomSN,e]);else if(t.isfirstGame)this.sendData(16778283,[this.playerData.roomSN,e]),t.isfirstGame=!1,laya.net.LocalStorage.setItem(StorageKeys.DZPKTakeScore+this.playerData.lastRoomId,JSON.stringify(t));else{var a=this.playerData.curTakeScore?this.playerData.curTakeScore:0;a=this.playerData.gold>=a?a:this.playerData.gold;var i=this.getRoomInfo(this.playerData.lastRoomId),s=i.maxchip,o=i.minTakeIn;a>s||a<o&&(a=o),this.sendData(16778283,[this.playerData.roomSN,a])}}else this.sendData(16778283,[this.playerData.roomSN,this.getTakeScore()])},e.prototype.getTakeScore=function(){var t=this.playerData.gold,e=this.getRoomInfo(this.playerData.gameType),a=e.maxchip>=t||0==e.maxchip?t:e.maxchip,i=i<a?i:a;return i=0==i?e.defaultTakeIn:i,i=i>t?t:i},e.prototype.showPiPei=function(){this.playerData.queueRoomType>0?(this.view.updataOperatePanel(-1),this.showOther("PiPeiVM")):Laya.timer.once(300,this,this.onShowPiPeiButton)},e.prototype.onShowPiPeiButton=function(){this._my_seat_no<=0&&this.view.updataOperatePanel(0)},e.prototype.showMenu=function(){this.showOther("MenuVM",this._player_list)},e.prototype.addScore=function(t){this.sendData(16778501,[t])},e.prototype.fold=function(){this.sendData(16778502)},e.prototype.getRoomInfo=function(t){var e=null;return this.playerData.roomDict[t]&&(e=this.playerData.roomDict[t]),e},e.prototype.onQuit=function(){this.is_show&&this.sendData(16778282,[this.playerData.lastRoomId])},e.prototype.eventInit=function(){this.regist("server_Client_syncProperty_Player_queueRoomType",this.showPiPei),this.regist("client_HoldemDeck_sitdown",this.playerEnter),this.regist("client_HoldemAgent_enterDeck",this.onEnterDeck),this.regist("client_HoldemDeck_takein",this.anyTakeIn),this.regist("client_Player_onTakeChip",this.playerTakeIn),this.regist("client_HoldemAgent_startNextHand",this.startNextHand),this.regist("client_HoldemAgent_recvHoleCard",this.recvHoleCard),this.regist("client_HoldemAgent_quit",this.onQuit),this.regist("client_HoldemDeck_play",this.seatPlay),this.regist("client_HoldemDeck_wait",this.seatWait),this.regist("client_HoldemDeck_openFlop",this.onOpenFlop),this.regist("client_HoldemDeck_openTurn",this.onOpenTurn),this.regist("client_HoldemDeck_openRiver",this.onOpenRive),this.regist("client_HoldemDeck_earlyWin",this.onEarlyWin),this.regist("client_HoldemDeck_showdown",this.onShowdown),this.regist("client_HoldemDeck_showCard",this.onShowCard),this.regist("client_HoldemDeck_viewCard",this.onViewCard)},e.prototype.addPlayerTo_player_list=function(t){var e=CFun.getItem(this._player_list,"rid",t.rid);e&&CFun.remove(this._player_list,e);var a=t.name;t.rid!=this.playerData.rid?t.name="****"+a.substring(a.length-3,a.length):t.name=a.substring(a.indexOf("_")+1,a.length),this._player_list.push(t)},e.prototype.quit=function(){this._player_list=[],this._my_seat_no=-1,this._public_cards=[],this.sendData(16778496)},e.prototype.sendPiPei=function(){this._player_list=[],this._my_seat_no=-1,this._public_cards=[],this.sendData(16778282,[this.playerData.lastRoomId])},e.prototype.onShow=function(e){t.prototype.onShow.call(this,this.playerData),0==this.playerData.curDeck?this.sendPiPei():this.sendData(16778281,[this.playerData.curDeck])},Object.defineProperty(e.prototype,"deckData",{get:function(){return ModelManager.ins.getInstByClassName("HoldemDeck")||CFun.throw("DZPKSceneVM中使用的HoldemDeck数据还未初始化"),ModelManager.ins.getInstByClassName("HoldemDeck")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"agentData",{get:function(){return ModelManager.ins.getInstByClassName("HoldemAgent")||CFun.throw("DZPKSceneVM中使用的HoldemAgent数据还未初始化"),ModelManager.ins.getInstByClassName("HoldemAgent")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"view",{get:function(){return this.cview.display},enumerable:!0,configurable:!0}),e}(r.MViewModel);e.DZPKSceneVM=n});